<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPREME V46 OMNIPOTENCE ULTIMATE | GHOST PROTOCOL</title>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/ext-language_tools.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* MASTER THEME ENGINE 
           Tüm sistemin görsel kimliği burada tanımlanır.
        */
        :root {
            --primary: #00d4ff; 
            --admin-neon: #00ff41; 
            --ghost-color: #d800ff; 
            --danger-neon: #ff003c; 
            --warning-neon: #ffcc00; 
            --ai-purple: #b080ff;
            --bg-ultra-dark: #010101; 
            --glass-panel: rgba(10, 10, 15, 0.98);
            --border-color: #1a1a1a;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-code: 'Fira Code', 'Cascadia Code', monospace;
        }

        /* RESET & BASE */
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        body { 
            height: 100vh; background: var(--bg-ultra-dark); color: #e0e0e0; 
            font-family: var(--font-main); overflow: hidden; display: flex; flex-direction: column; 
        }

        /* SCANLINE & GLITCH ANIMATION */
        body::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 99999; background-size: 100% 4px, 4px 100%; pointer-events: none; opacity: 0.4;
        }

        /* AUTH GATE - ENTRANCE */
        #auth-gate { 
            position: fixed; inset: 0; background: #000; z-index: 100000; 
            display: flex; justify-content: center; align-items: center; 
            transition: 1s ease-in-out;
        }
        .gate-card { 
            width: 500px; padding: 60px; border: 1px solid var(--primary); 
            background: rgba(5,5,5,1); text-align: center; 
            box-shadow: 0 0 100px rgba(0,212,255,0.05); border-radius: 4px;
        }
        .gate-title { font-size: 32px; letter-spacing: 10px; color: var(--primary); margin-bottom: 30px; text-transform: uppercase; }

        /* HEADER UI */
        header { 
            height: 80px; background: rgba(0,0,0,0.95); border-bottom: 1px solid var(--border-color); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 40px; 
            z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .brand { font-weight: 900; color: var(--primary); font-size: 24px; letter-spacing: 4px; display: flex; align-items: center; gap: 15px; }
        .nav-btn { 
            background: transparent; color: var(--primary); border: 1px solid var(--primary); 
            padding: 12px 24px; border-radius: 2px; cursor: pointer; font-size: 11px; 
            font-weight: bold; text-transform: uppercase; transition: 0.4s; letter-spacing: 1px;
        }
        .nav-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }

        /* LAYOUT CORE */
        main { display: grid; grid-template-columns: 320px 1fr 400px; flex: 1; overflow: hidden; }

        /* LEFT SIDEBAR - SYSTEM LOGS */
        .sidebar-logs { 
            background: #050505; border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; padding: 20px; 
        }
        .log-header { font-size: 10px; color: #444; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px; }
        #log-stream { flex: 1; overflow-y: auto; font-family: var(--font-code); font-size: 11px; color: #666; }
        .log-line { margin-bottom: 6px; padding: 4px; border-left: 2px solid #222; padding-left: 10px; }
        .log-line.info { border-color: var(--primary); color: #888; }
        .log-line.warn { border-color: var(--warning-neon); color: var(--warning-neon); }

        /* CENTER - CODE EDITOR */
        .editor-zone { position: relative; display: flex; flex-direction: column; background: #000; }
        #ace-editor { flex: 1; font-size: 16px !important; }
        
        /* TERMINAL PANEL */
        #terminal-panel { 
            position: absolute; bottom: 0; width: 100%; height: 35%; 
            background: rgba(2, 2, 2, 0.98); border-top: 1px solid var(--primary); 
            display: none; flex-direction: column; z-index: 5000;
        }
        .term-head { background: #111; padding: 10px 20px; font-size: 12px; color: var(--primary); display: flex; justify-content: space-between; }
        #term-out { padding: 20px; overflow-y: auto; flex: 1; font-family: var(--font-code); color: var(--primary); font-size: 14px; white-space: pre-wrap; }

        /* RIGHT SIDEBAR - CHAT & AI */
        .sidebar-right { background: #080808; border-left: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .chat-container { flex: 1.5; display: flex; flex-direction: column; border-bottom: 1px solid #111; }
        .ai-container { flex: 1; display: flex; flex-direction: column; background: rgba(176, 128, 255, 0.02); }
        .panel-title { padding: 15px; font-size: 10px; color: #333; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }
        .msg-display { flex: 1; overflow-y: auto; padding: 20px; font-size: 13px; }
        .input-group { padding: 20px; background: #050505; display: flex; gap: 10px; }
        .flat-input { 
            flex: 1; background: #0a0a0a; border: 1px solid #222; color: #fff; padding: 12px; 
            border-radius: 2px; font-family: var(--font-code); transition: 0.3s;
        }
        .flat-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,212,255,0.1); }

        /* OVERLORD ULTIMATE ADMIN PANEL */
        #overlord-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 90000; 
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px);
        }
        .overlord-frame { 
            width: 1200px; height: 800px; background: #0a0a0a; border: 1px solid var(--admin-neon); 
            display: flex; border-radius: 4px; overflow: hidden; box-shadow: 0 0 100px rgba(0,255,65,0.1);
        }
        .overlord-nav { width: 280px; background: #050505; border-right: 1px solid #1a1a1a; padding: 40px 20px; }
        .ov-btn { 
            width: 100%; padding: 15px; color: #444; text-align: left; cursor: pointer; 
            border-radius: 4px; margin-bottom: 10px; transition: 0.3s; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 15px; border: 1px solid transparent;
        }
        .ov-btn:hover { color: var(--admin-neon); background: rgba(0,255,65,0.02); }
        .ov-btn.active { background: rgba(0,255,65,0.08); color: var(--admin-neon); border-color: var(--admin-neon); }
        
        .overlord-main { flex: 1; padding: 50px; overflow-y: auto; position: relative; }
        .ov-section { display: none; }
        .ov-section.active { display: block; animation: fadeIn 0.5s ease; }
        
        /* ADMIN CARDS */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
        .admin-card { background: #0e0e0e; border: 1px solid #1a1a1a; padding: 30px; border-radius: 4px; }
        .admin-card h4 { color: #555; font-size: 11px; margin-bottom: 15px; text-transform: uppercase; }
        .big-stat { font-size: 32px; font-weight: 900; font-family: var(--font-code); color: var(--admin-neon); }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FOOTER */
        footer { 
            height: 40px; background: #000; border-top: 1px solid #111; 
            display: flex; align-items: center; padding: 0 30px; font-size: 11px; color: #333; 
        }
        .stat-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--admin-neon); margin-right: 10px; box-shadow: 0 0 10px var(--admin-neon); }
    </style>
</head>
<body>

<div id="auth-gate">
    <div class="gate-card">
        <div class="gate-title">SYSTEM_BOOT</div>
        <div style="text-align:left; background:#0a0a0a; padding:20px; border-radius:4px; margin-bottom:30px; font-family:var(--font-code); font-size:12px; color:#444;">
            > V46 OMNIPOTENCE LOADED...<br>
            > 15+ LANGUAGES CONFIGURED...<br>
            > ADMIN SPY PROTOCOL: READY...<br>
            > FIREWALL STATUS: LEVEL 7...
        </div>
        <input type="text" id="uid" class="flat-input" style="width:100%; margin-bottom:15px; border-color:#333;" placeholder="ROOT IDENTIFIER">
        <input type="password" id="ukey" class="flat-input" style="width:100%; margin-bottom:30px; border-color:#333;" placeholder="ACCESS HASH">
        <button class="nav-btn" style="width:100%" onclick="systemBoot()">INITIALIZE OMNIPOTENCE</button>
    </div>
</div>

<div id="overlord-modal">
    <div class="overlord-frame">
        <div class="overlord-nav">
            <div style="margin-bottom:40px; text-align:center;">
                <h2 style="color:var(--admin-neon); letter-spacing:5px;">OVERLORD</h2>
                <span style="font-size:9px; color:#444;">V46 ULTIMATE COMMAND CENTER</span>
            </div>
            <div class="ov-btn active" onclick="switchTab(this, 'dash')"><i class="fas fa-chart-area"></i> DASHBOARD</div>
            <div class="ov-btn" onclick="switchTab(this, 'spy')"><i class="fas fa-fingerprint"></i> SPY PROTOCOL</div>
            <div class="ov-btn" onclick="switchTab(this, 'network')"><i class="fas fa-network-wired"></i> TRAFFIC ANALYZER</div>
            <div class="ov-btn" onclick="switchTab(this, 'firewall')"><i class="fas fa-user-shield"></i> FIREWALL OPS</div>
            <div class="ov-btn" onclick="switchTab(this, 'theme')"><i class="fas fa-palette"></i> THEME ENGINE</div>
            <div class="ov-btn" onclick="switchTab(this, 'wipe')"><i class="fas fa-trash-alt"></i> DATA PURGE</div>
            <div style="margin-top:100px;">
                <button class="nav-btn" style="width:100%; border-color:var(--danger-neon); color:var(--danger-neon);" onclick="closeOverlord()">CLOSE CORE</button>
            </div>
        </div>

        <div class="overlord-main">
            <div id="ov-dash" class="ov-section active">
                <h3 style="margin-bottom:30px; color:#fff;">SİSTEM METRİKLERİ</h3>
                <div class="stat-grid">
                    <div class="admin-card"><h4>CPU LOAD</h4><div id="cpu-val" class="big-stat">04.12%</div></div>
                    <div class="admin-card"><h4>MEMORY USAGE</h4><div class="big-stat">1.44 GB</div></div>
                    <div class="admin-card"><h4>ACTIVE SESSIONS</h4><div class="big-stat">1 ONLINE</div></div>
                    <div class="admin-card"><h4>DATABASE DELAY</h4><div class="big-stat">12ms</div></div>
                </div>
            </div>

            <div id="ov-spy" class="ov-section">
                <h3 style="margin-bottom:15px; color:#fff;">GHOST SPY MODE</h3>
                <p style="color:#555; margin-bottom:20px;">Tüm özel mesajlar (PM) ve gizli paketler bu ekrana düşer.</p>
                <div id="spy-stream" style="background:#000; height:400px; padding:20px; border:1px solid #1a1a1a; font-family:var(--font-code); color:var(--admin-neon); overflow-y:auto; font-size:12px;">
                    [INIT] Packet sniffer started...
                </div>
                <button class="nav-btn" id="spy-toggle" style="margin-top:20px;" onclick="toggleSpyMode()">SPY MODE: OFF</button>
            </div>

            <div id="ov-network" class="ov-section">
                <h3 style="margin-bottom:20px;">NETWORK TRAFFIC</h3>
                <div class="admin-card" style="height:350px; font-family:var(--font-code); font-size:12px; color:#444;">
                    <div style="margin-bottom:10px;">INCOMING: 1.2 MB/s</div>
                    <div style="margin-bottom:10px;">OUTGOING: 0.4 MB/s</div>
                    <div style="height:250px; border-bottom:1px solid #222; position:relative;">
                        <div style="position:absolute; bottom:0; width:100%; height:40%; background:linear-gradient(transparent, var(--primary)); opacity:0.1;"></div>
                    </div>
                </div>
            </div>

            <div id="ov-theme" class="ov-section">
                <h3>THEME ENGINE</h3>
                <div class="admin-card" style="margin-top:20px;">
                    <label style="font-size:11px; color:#444;">PRIMARY NEON COLOR</label>
                    <input type="color" id="theme-color" style="width:100%; height:50px; background:none; border:1px solid #222; margin-top:10px;">
                    <button class="nav-btn" style="width:100%; margin-top:20px;" onclick="updateTheme()">APPLY VISUALS</button>
                </div>
            </div>

            <div id="ov-wipe" class="ov-section">
                <h3>VERİ İMHASI</h3>
                <div class="admin-card" style="border-color:var(--danger-neon); margin-top:20px;">
                    <p style="color:#888;">Bu işlem geri döndürülemez. Tüm veritabanı silinecektir.</p>
                    <button class="nav-btn" style="border-color:var(--danger-neon); color:var(--danger-neon); margin-top:20px;" onclick="purgeDatabase()">PURGE ALL DATA</button>
                </div>
            </div>
        </div>
    </div>
</div>

<header>
    <div class="brand">
        <i class="fas fa-skull-crossbones"></i>
        <span>V46_OMNIPOTENCE</span>
    </div>
    <div style="display:flex; gap:15px;">
        <button id="admin-trigger" class="nav-btn" style="display:none; border-color:var(--admin-neon); color:var(--admin-neon);" onclick="openOverlord()">OVERLORD</button>
        <button class="nav-btn" onclick="exportSupreme()"><i class="fas fa-download"></i> DIŞA AKTAR</button>
        <select id="lang-selector" class="nav-btn" style="background:#000;" onchange="syncEnvironment()">
            <optgroup label="Sık Kullanılanlar">
                <option value="python">Python 3.11</option>
                <option value="javascript">JavaScript ES2024</option>
                <option value="html">HTML5 Render</option>
            </optgroup>
            <optgroup label="Sistem Dilleri">
                <option value="c_cpp">C++ (GCC)</option>
                <option value="rust">Rust (Cargo)</option>
                <option value="golang">Go (Golang)</option>
                <option value="java">Java 21</option>
            </optgroup>
            <optgroup label="Web & Veri">
                <option value="php">PHP 8.3</option>
                <option value="sql">SQL (Postgres)</option>
                <option value="typescript">TypeScript</option>
                <option value="css">CSS4</option>
            </optgroup>
        </select>
        <button class="nav-btn" style="background:var(--primary); color:#000;" onclick="executeKernel()"><i class="fas fa-bolt"></i> ÇALIŞTIR</button>
    </div>
</header>

<main>
    <section class="sidebar-logs">
        <div class="log-header">SYSTEM_OPERATIONS</div>
        <div id="log-stream"></div>
    </section>

    <section class="editor-zone">
        <div id="ace-editor"># SUPREME V46 OMNIPOTENCE ULTIMATE
# Ghost Protocol Active. 
# Initializing multi-language environment...

def system_status():
    status = "READY"
    print(f"OMNIPOTENCE_KERNEL: {status}")

if __name__ == "__main__":
    system_status()</div>

        <div id="terminal-panel">
            <div class="term-head">
                <span>SYSTEM_CONSOLE v46.0.9</span>
                <span onclick="toggleTerminal(false)" style="cursor:pointer;">[X] CLOSE</span>
            </div>
            <div id="term-out"></div>
        </div>
    </section>

    <section class="sidebar-right">
        <div class="chat-container">
            <div class="panel-title">GLOBAL_ENCRYPTED_COMMS</div>
            <div id="chat-stream" class="msg-display"></div>
            <div class="input-group">
                <input type="text" id="chat-input" class="flat-input" placeholder="Type /msg @user ...">
                <button class="nav-btn" style="padding:10px 15px;" onclick="sendPacket()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div class="ai-container">
            <div class="panel-title" style="color:var(--ai-purple)">GHOST_AI_ANALYST</div>
            <div id="ai-stream" class="msg-display" style="color:var(--ai-purple); font-size:12px;">AI: Waiting for neural input...</div>
            <div class="input-group">
                <input type="text" id="ai-input" class="flat-input" style="border-color:rgba(176,128,255,0.2)" placeholder="Ask AI...">
                <button class="nav-btn" style="border-color:var(--ai-purple); color:var(--ai-purple);" onclick="askGhost()"><i class="fas fa-brain"></i></button>
            </div>
        </div>
    </section>
</main>

<footer>
    <div class="stat-dot"></div>
    <div style="margin-right:20px;">SYSTEM_ONLINE</div>
    <div id="foot-lang" style="color:var(--primary); text-transform:uppercase;">LANG: PYTHON</div>
    <div style="flex:1"></div>
    <div>V46.0.9-ULTIMATE PRO BUILD | 2026</div>
</footer>

<script>
    /* OMNIPOTENCE CORE SCRIPTING 
       Bu bölüm tüm sistemin beynidir.
    */

    // FIREBASE INITIALIZATION
    const firebaseConfig = { apiKey: "AIzaSyDpaFcKI6XhYuWCiyZHUFey0T6uqKy8IPA", databaseURL: "https://prem-d18e3-default-rtdb.firebaseio.com", projectId: "prem-d18e3" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // GLOBAL VARIABLES
    let pyodideInstance = null;
    let currentUser = "Guest_" + Math.floor(Math.random()*9999);
    let isAdmin = false;
    let isSpyActive = false;

    // ACE EDITOR CONFIG
    const editor = ace.edit("ace-editor");
    editor.setTheme("ace/theme/terminal");
    editor.session.setMode("ace/mode/python");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true,
        showPrintMargin: false,
        fontSize: "16px",
        fontFamily: "var(--font-code)"
    });

    // LANGUAGE METADATA (15+ Languages)
    const LANGUAGES = {
        python: { ext: "py", info: "Python 3.11 Runtime" },
        javascript: { ext: "js", info: "Node.js/V8 Engine" },
        html: { ext: "html", info: "HTML5 Render" },
        c_cpp: { ext: "cpp", info: "GCC Compiler Required" },
        rust: { ext: "rs", info: "Cargo/Rustc Required" },
        golang: { ext: "go", info: "Go Runtime Required" },
        java: { ext: "java", info: "OpenJDK 21 Required" },
        csharp: { ext: "cs", info: "Dotnet SDK Required" },
        php: { ext: "php", info: "PHP 8.3 Runtime" },
        sql: { ext: "sql", info: "PostgreSQL Query" },
        ruby: { ext: "rb", info: "Ruby Interpreter" },
        typescript: { ext: "ts", info: "TS-Node Required" }
    };

    // SYSTEM BOOT FUNCTION
    async function systemBoot() {
        const idInput = document.getElementById("uid").value;
        const keyInput = document.getElementById("ukey").value;

        if(!idInput) return alert("ERROR: Identifier required.");

        currentUser = idInput;
        if(idInput === "@rw_f00t" && keyInput === "f00t_99x_Root!") {
            isAdmin = true;
            document.getElementById("admin-trigger").style.display = "block";
            pushSysLog("ADMIN PRIVILEGES ACTIVATED.", "warn");
        }

        document.getElementById("auth-gate").style.opacity = "0";
        setTimeout(() => document.getElementById("auth-gate").style.display = "none", 1000);

        pushSysLog("System boot sequence completed.", "info");
        
        // Load Python Kernel
        try {
            pyodideInstance = await loadPyodide();
            pushSysLog("Python Kernel: ONLINE", "info");
        } catch(e) { pushSysLog("Kernel Error: " + e, "warn"); }

        // Start CPU Simulator
        setInterval(() => {
            if(isAdmin) {
                const cpu = (Math.random() * 10 + 2).toFixed(2);
                document.getElementById("cpu-val").innerText = cpu + "%";
            }
        }, 3000);
    }

    // CORE LOGIC: EXECUTION
    async function executeKernel() {
        const lang = document.getElementById("lang-selector").value;
        const term = document.getElementById("term-out");
        const panel = document.getElementById("terminal-panel");
        
        panel.style.display = "flex";
        term.innerText = `[EXEC] Running ${lang} kernel...\n--------------------------------\n`;

        try {
            if(lang === "python") {
                await pyodideInstance.runPythonAsync(`import sys, io\nsys.stdout = io.StringIO()`);
                await pyodideInstance.runPythonAsync(editor.getValue());
                const output = pyodideInstance.runPython("sys.stdout.getvalue()");
                term.innerText += output || "Process finished with exit code 0";
            } else if(lang === "javascript") {
                const result = eval(editor.getValue());
                term.innerText += "Result: " + (result || "Code executed successfully.");
            } else if(lang === "html") {
                const win = window.open();
                win.document.write(editor.getValue());
                term.innerText += "HTML Rendered in a new tab.";
            } else {
                term.innerText += `[SYSTEM] ${lang.toUpperCase()} is a compiled language.\nCode analysis: SUCCESS.\nPlease export and use local compiler.`;
            }
        } catch(e) {
            term.innerHTML += `<span style="color:var(--danger-neon)">ERROR: ${e}</span>`;
        }
    }

    // CORE LOGIC: EXPORT
    function exportSupreme() {
        const code = editor.getValue();
        const lang = document.getElementById("lang-selector").value;
        const meta = LANGUAGES[lang] || { ext: "txt" };
        const blob = new Blob([code], {type: "text/plain"});
        const a = document.createElement("a");
        const filename = `OmniProject_${Date.now()}.${meta.ext}`;
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        pushSysLog(`File Exported: ${filename}`, "info");
    }

    // UI MODULE: OVERLORD
    function openOverlord() { document.getElementById("overlord-modal").style.display = "flex"; }
    function closeOverlord() { document.getElementById("overlord-modal").style.display = "none"; }
    
    function switchTab(el, tabId) {
        document.querySelectorAll(".ov-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".ov-section").forEach(s => s.classList.remove("active"));
        el.classList.add("active");
        document.getElementById("ov-" + tabId).classList.add("active");
    }

    function toggleSpyMode() {
        isSpyActive = !isSpyActive;
        const btn = document.getElementById("spy-toggle");
        btn.innerText = isSpyActive ? "SPY MODE: ON" : "SPY MODE: OFF";
        btn.style.borderColor = isSpyActive ? "var(--admin-neon)" : "var(--danger-neon)";
        pushSysLog(`Spy Protocol ${isSpyActive ? 'Enabled' : 'Disabled'}`, "warn");
    }

    function updateTheme() {
        const color = document.getElementById("theme-color").value;
        document.documentElement.style.setProperty('--primary', color);
        pushSysLog("Theme primary color updated.", "info");
    }

    // COMMS MODULE: CHAT & SPY
    function sendPacket() {
        const inp = document.getElementById("chat-input");
        if(!inp.value) return;

        let msg = inp.value;
        let priv = false, target = "";

        if(msg.startsWith("/msg")) {
            const parts = msg.split(" ");
            target = parts[1].replace("@","");
            msg = parts.slice(2).join(" ");
            priv = true;
        }

        database.ref("v46_ultimate_chat").push({
            user: currentUser,
            text: msg,
            isPrivate: priv,
            target: target,
            isAdmin: isAdmin,
            timestamp: Date.now()
        });
        inp.value = "";
    }

    database.ref("v46_ultimate_chat").limitToLast(40).on("value", snap => {
        const display = document.getElementById("chat-stream");
        const spy = document.getElementById("spy-stream");
        display.innerHTML = "";
        
        snap.forEach(child => {
            const val = child.val();
            const canSee = !val.isPrivate || (val.target === currentUser || val.user === currentUser || (isAdmin && isSpyActive));
            
            if(canSee) {
                const color = val.isAdmin ? "var(--admin-neon)" : (val.isPrivate ? "var(--ghost-color)" : "var(--primary)");
                display.innerHTML += `
                    <div style="margin-bottom:10px; border-bottom:1px solid #111; padding-bottom:5px;">
                        <b style="color:${color}">${val.user}${val.isPrivate ? ' [PM]' : ''}:</b> ${val.text}
                    </div>
                `;
            }

            if(isAdmin && isSpyActive) {
                spy.innerHTML = `[${new Date(val.timestamp).toLocaleTimeString()}] ${val.user} -> ${val.target || 'GLOBAL'}: ${val.text}\n` + spy.innerHTML;
            }
        });
        display.scrollTop = display.scrollHeight;
    });

    // AI MODULE: GHOST ANALYST
    function askGhost() {
        const inp = document.getElementById("ai-input");
        const stream = document.getElementById("ai-stream");
        if(!inp.value) return;

        stream.innerHTML += `<div style="color:#666; margin-top:5px;">> ${inp.value}</div>`;
        setTimeout(() => {
            stream.innerHTML += `<div style="margin-top:5px;">AI: Kod segmenti analiz edildi. Dil: ${document.getElementById("lang-selector").value}. Verimlilik: %94.</div>`;
            stream.scrollTop = stream.scrollHeight;
        }, 1000);
        inp.value = "";
    }

    // UTILITY MODULES
    function pushSysLog(m, type) {
        const s = document.getElementById("log-stream");
        const div = document.createElement("div");
        div.className = "log-line " + type;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${m}`;
        s.prepend(div);
    }

    function syncEnvironment() {
        const lang = document.getElementById("lang-selector").value;
        editor.session.setMode("ace/mode/" + lang);
        document.getElementById("foot-lang").innerText = "LANG: " + lang;
        pushSysLog(`Environment synced to ${lang}`, "info");
    }

    function toggleTerminal(show) { document.getElementById("terminal-panel").style.display = show ? "flex" : "none"; }
    function purgeDatabase() { if(confirm("Kritik Uyarı: Veritabanı temizlenecek?")) database.ref("v46_ultimate_chat").remove(); }

</script>
</body>
</html>
